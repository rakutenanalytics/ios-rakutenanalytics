# Import base_config from git
import_from_git(url: 'https://github.com/rakutentech/ios-buildconfig.git')

platform :ios do
  desc "Build everything"
  lane :ci do |options|
    shared_tests(options)
    build_sample(options)
  end

  desc "Build SDK"
  lane :build_sdk do |options|
    podspec = "RakutenAnalyticsSDK/RAnalytics.podspec"
    version = version_get_podspec(path: podspec)

    # ensure clean install
    sh "rm -rf ../Samples/RAnalytics.zip"
    sh "rm -rf ../Samples/Pods;rm -f ../Samples/Podfile.lock"
    sh "pod cache clean RAnalytics --all"

    build_framework(version: version) unless options[:skip_build]

    # copy specifc version's framework zip to the Samples folder
    sh "cp ../RakutenAnalyticsSDK/RAnalyticsDebug-v#{version}.zip ../Samples/RAnalytics.zip"

    # for `pod install` cocoapods needs the podspec included in the zip 
    sh "zip -urj ../Samples/RAnalytics.zip ../#{podspec}"
  end

  desc "Build sample"
  lane :build_sample do |options|
    build_sdk(options)
    shared_sample(options)
  end

  # Upload sample
  desc "Upload sample - note: build_sample must be run prior"
  lane :upload_sample do |options|
    appcenter_upload(app_name: "RSDKAnalyticsSample", notify_testers: true, ipa: "./artifacts/device/RAnalyticsSample.ipa", dsym: "./artifacts/device/RAnalyticsSample.app.dSYM.zip")
  end

  # Build RAnalyticsSampleSwiftUI
  desc "Build SwiftUI sample with the public RAnalytics SDK"
  lane :build_sample_swiftui do |options|
    build_sdk(options)
    cocoapods(podfile: "Samples/Podfile")
    gym(
      configuration: "Release",
      output_directory: './artifacts/device',
      workspace: "Samples/RAnalyticsSample.xcworkspace",
      codesigning_identity: 'iPhone Distribution',
      export_method: 'enterprise',
      export_team_id: ENV['REM_FL_EXPORT_TEAM_ID'],
      export_options: {
        uploadBitcode: false,
        compileBitcode: false,
      },
      scheme: "RAnalyticsSampleSwiftUI")
  end

  # Upload RAnalyticsSampleSwiftUI
  desc "Upload SwiftUI sample built with the public RAnalytics SDK"
  lane :upload_sample_swiftui do |options|
    build_sample_swiftui()
    appcenter_upload(app_name: "RSDKAnalyticsSample", notify_testers: true, ipa: "./artifacts/device/RAnalyticsSampleSwiftUI.ipa", dsym: "./artifacts/device/RAnalyticsSampleSwiftUI.app.dSYM.zip")
  end

  # Build RAnalyticsSampleSPMInternal
  desc "Build sample with the internal RAnalytics Swift Package"
  lane :build_sample_spm_internal do |options|
    gym(
      configuration: "Release",
      output_directory: './artifacts/device',
      project: "SamplesSPMInternal/RAnalyticsSampleSPM.xcodeproj",
      codesigning_identity: 'iPhone Distribution',
      export_method: 'enterprise',
      export_team_id: ENV['REM_FL_EXPORT_TEAM_ID'],
      export_options: {
        uploadBitcode: false,
        compileBitcode: false,
      },
      scheme: "RAnalyticsSampleSPM")
  end

  # Upload RAnalyticsSampleSPMInternal
  desc "Upload sample built with the internal RAnalytics Swift Package"
  lane :upload_sample_spm_internal do |options|
    build_sample_spm_internal()
    appcenter_upload(app_name: "RSDKAnalyticsSample", notify_testers: true, ipa: "./artifacts/device/RAnalyticsSampleSPMInternal.ipa", dsym: "./artifacts/device/RAnalyticsSampleSPMInternal.app.dSYM.zip")
  end

  desc "Build and release public framework, options are 'version' (string, mandatory), 'release' (boolean, defaults false), 'skip_build' (boolean), 'skip_upload' (boolean), 'skip_pod_push' (boolean), 'target_branch'"
  lane :deploy_framework do |options|
    version = options[:version]
    podspecPath = "RakutenAnalyticsSDK/RAnalytics.podspec"
    podspecVersion = version_get_podspec(path: podspecPath)
    isSnapshot = !options[:release]
    UI.user_error!("The passed in version parameter #{version || "NONE"} and podspec version #{podspecVersion} must match") unless version == podspecVersion
    
    build_framework(version: version) unless options[:skip_build]
    sh "ls ../RakutenAnalyticsSDK/RAnalytics*.zip"

    commit_message = "Built from internal commit #{last_git_commit[:commit_hash]}"
    release_name = "Public Analytics SDK Release v#{version}"

    skip_upload = options[:skip_upload] || false
    skip_pod_push = options[:skip_pod_push] || false
    
    release_description = "\n\n#{commit_message}\n" + File.read("changelog") rescue commit_message
    target_branch = options[:target_branch] || "master"
    private_assets = [
      "RakutenAnalyticsSDK/RAnalyticsRelease-v#{version}.zip", 
      "RakutenAnalyticsSDK/RAnalyticsDebug-v#{version}.zip",
      "RakutenAnalyticsSDK/RAnalyticsDebug_dSYM-v#{version}.zip",
      "RakutenAnalyticsSDK/RAnalyticsRelease_dSYM-v#{version}.zip",
    ]

    pod_lib_lint(podspec: podspecPath, allow_warnings: true)

    upload_swift_package(version: version, release: !isSnapshot, target_branch: target_branch) unless options[:skip_build] || skip_upload

    if isSnapshot
      snapshot_repo = "rakutentech/ios-analytics-framework-snapshots"
      UI.message "Upload snapshot '#{release_name}' to GitHub repo #{snapshot_repo}, branch #{target_branch}"
      UI.message "Commit message: #{commit_message}"

      github_release = set_github_release(
        repository_name: snapshot_repo,
        api_token: ENV["SNAPSHOT_GITHUB_TOKEN"],
        name: "[Snapshot] " + release_name,
        tag_name: version,
        description: release_description,
        commitish: target_branch,
        upload_assets: private_assets
      ) unless skip_upload

      unless skip_pod_push
        push_podspec(path: podspecPath, repo: snapshot_repo, token: ENV["SNAPSHOT_GITHUB_TOKEN"])
      end

      UI.success "Successfully released snapshot v#{version}"
    else
      # release mode i.e. snapshot=false
      private_repo = "mag/ios-analytics-private-artifacts"
      UI.message "Upload PRIVATE artifacts to on-prem GHE repo: #{private_repo}, branch: #{target_branch}, description: #{release_description}"

      # upload all artifacts to private repo on GHE
      github_release = set_github_release(
        server_url: "https://ghe.rakuten-it.com/api/v3",
        repository_name: private_repo,
        api_token: ENV["RELEASE_GHE_TOKEN"],
        name: release_name,
        tag_name: version,
        description: release_description,
        commitish: target_branch,
        upload_assets: private_assets
      ) unless skip_upload

      public_repo = "rakutentech/ios-analytics-framework"
      UI.message "Upload PUBLIC artifacts to GitHub repo: #{public_repo}, branch #{target_branch}, description: #{release_description}"

      # upload RELEASE framework to public GitHub repo and push podspec
      github_release = set_github_release(
        repository_name: public_repo,
        api_token: ENV["RELEASE_GITHUB_TOKEN"],
        name: release_name,
        tag_name: version,
        description: release_description,
        commitish: target_branch,
        upload_assets: ["RakutenAnalyticsSDK/RAnalyticsRelease-v#{version}.zip"]
      ) unless skip_upload

      unless skip_pod_push
        push_podspec(path: podspecPath, repo: public_repo, token: ENV["RELEASE_GITHUB_TOKEN"])
      end

      UI.success "Successfully released v#{version}"
    end
  end

  desc "Push podspec to repository"
  lane :push_podspec do |options|
    podspecPath = options[:path]
    repo = options[:repo]
    pod_repo = "rakutentech-analytics-framework-push" # pod repos with "/" in the name don't work properly
    token = options[:token]

    UI.message "Removing existing pod repo"
    sh "bundle exec pod repo remove #{pod_repo} > /dev/null", error_callback: ->(result) { UI.message "Pod repo did not exist" }
    sh "bundle exec pod repo add #{pod_repo} https://#{token}@github.com/#{repo}.git"
    begin
      pod_push(path: podspecPath, repo:pod_repo, use_bundle_exec: true, allow_warnings: true)
    ensure
      sh "bundle exec pod repo remove #{pod_repo}"
    end
  end

  desc "Commit version bump in CoreHelpers.Constants.sdkVersion, _versions, .jazzy.yaml, Info.plist, podspec"
  lane :commit_sdk_ver_bump do |options|
    target_version = options[:version]
    UI.user_error!("version param must be passed in") unless !target_version.to_s.empty?
    replacing = "static let sdkVersion = \"#{target_version}\""
    regex = "static let sdkVersion = .*"
    constant_file = "CoreHelpers.swift"
    sh "find .. -type f -name '#{constant_file}' -exec sed -i '' -e 's/#{regex}/#{replacing}/g' {} ';'"
    if target_version["snapshot"]
      UI.message "Skipping docs version bump because of snapshot version"
    else
      sh "sed -i '' -e 's/module_version: .*/module_version: #{target_version}/g' ../.jazzy.yaml"
      sh "echo #{target_version} >>../_versions 2>&1"
    end
    increment_version_number(version_number: target_version, xcodeproj: 'RakutenAnalyticsSDK/RAnalytics.xcodeproj')
    version_bump_podspec(path: 'RAnalytics.podspec', version_number: target_version)
    version_bump_podspec(path: 'RakutenAnalyticsSDK/RAnalytics.podspec', version_number: target_version)
    git_commit(
      path: ["**/#{constant_file}", ".jazzy.yaml", "_versions", "RAnalytics.podspec", "RakutenAnalyticsSDK/RAnalytics.podspec", "**/Info.plist"],
      message: "chore: bump sdkVersion to #{target_version}")
  end
end

# vim:syntax=ruby:et:sts=2:sw=2:ts=2:ff=unix:
